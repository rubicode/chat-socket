<html>

<head>
    <title>Daftar Siswa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="/javascripts/helper.js"></script>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-header text-center">
                <h1>Daftar Siswa</h1>
            </div>
            <div class="card-body">
                <form id="form-siswa">
                    <input type="hidden" id="id" value="">
                    <div class="row mb-3">
                        <label for="username" class="col-sm-2 col-form-label">Username</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="username">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="address" class="col-sm-2 col-form-label">Address</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" id="address"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </form>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Username</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="content">
                </tbody>
            </table>
            <div class="card-footer">
                <button type="button" class="btn btn-danger" onclick="logout()">Keluar</button>
            </div>
        </div>

    </div>

    <script>
        const token = checkToken()

        const socket = io();


        $(function () {
            socket.on('load-data', () => {
                console.log('backend suruh load data')
                getData()
            })

            getData()

            $('#form-siswa').submit(function (event) {
                event.preventDefault()
                saveData()
                socket.emit('refresh-data')
            })
        })

        const getData = async () => {
            $.ajax({
                method: "GET",
                url: "/users",
                headers: {
                    Authorization: `Bearer ${token}`
                }
            }).done(function (data) {
                let html = ''
                data.forEach((item, index) => {
                    html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.username}</td>
                                <td>${item.address}</td>
                                <td>
                                <button class="btn btn-success" type="button"onClick="editData('${item._id}')">edit</button>
                                <button class="btn btn-danger" type="button" onClick="deleteData('${item._id}')">delete</button>
                                </td>
                            </tr>
                            `
                })
                $('#content').html(html)
            });
        }

        const saveData = async () => {
            const id = $('#id').val()
            const username = $('#username').val()
            const address = $('#address').val()

            $.ajax({
                method: id ? "PUT" : "POST",
                url: id ? `/users/${id}` : "/users",
                data: { username, address }
            }).done(function (data) {
                $('#id').val('')
                $('#username').val('')
                $('#address').val('')
                getData()
            }).fail(function (err) {
                alert('gagal simpan data')
            })
        }

        const deleteData = async (id) => {
            $.ajax({
                method: "DELETE",
                url: `/users/${id}`
            }).done(function (data) {
                getData()
                socket.emit('refresh-data')
            });
        }

        const editData = async (id) => {
            $.ajax({
                method: "GET",
                url: `/users/${id}`
            }).done(function (data) {
                $('#id').val(data._id)
                $('#username').val(data.username)
                $('#address').val(data.address)
            });
        }
    </script>

</body>

</html>